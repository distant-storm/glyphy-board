<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Schedules</title>
    <link rel="stylesheet" type="text/css" href="{{ url_for('static',filename='styles/main.css') }}">
    <script src="{{ url_for('static', filename='scripts/response_modal.js') }}"></script>
    <script>
        let currentScheduleId = null;
        let currentItemId = null;
        let editingItem = false;

        async function createSchedule() {
            const name = document.getElementById('scheduleName').value.trim();
            const active = document.getElementById('scheduleActive').checked;

            if (!name) {
                showResponseModal('failure', 'Schedule name is required');
                return;
            }

            try {
                const response = await fetch("{{ url_for('schedules.create_schedule') }}", {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ name, active })
                });

                const result = await response.json();
                if (response.ok) {
                    showResponseModal('success', result.message);
                    setTimeout(() => location.reload(), 1000);
                } else {
                    showResponseModal('failure', result.error);
                }
            } catch (error) {
                console.error('Error:', error);
                showResponseModal('failure', 'An error occurred while creating the schedule');
            }
        }

        async function updateSchedule(scheduleId, name, active) {
            try {
                const response = await fetch(`/schedules/${scheduleId}`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ name, active })
                });

                const result = await response.json();
                if (response.ok) {
                    showResponseModal('success', result.message);
                    setTimeout(() => location.reload(), 1000);
                } else {
                    showResponseModal('failure', result.error);
                }
            } catch (error) {
                console.error('Error:', error);
                showResponseModal('failure', 'An error occurred while updating the schedule');
            }
        }

        async function deleteSchedule(scheduleId) {
            if (!confirm('Are you sure you want to delete this schedule? All schedule items will also be deleted.')) {
                return;
            }

            try {
                const response = await fetch(`/schedules/${scheduleId}`, {
                    method: 'DELETE'
                });

                const result = await response.json();
                if (response.ok) {
                    showResponseModal('success', result.message);
                    setTimeout(() => location.reload(), 1000);
                } else {
                    showResponseModal('failure', result.error);
                }
            } catch (error) {
                console.error('Error:', error);
                showResponseModal('failure', 'An error occurred while deleting the schedule');
            }
        }

        async function createScheduleItem() {
            const boardName = document.getElementById('itemBoardName').value.trim();
            const scheduleType = document.querySelector('input[name="scheduleType"]:checked').value;

            if (!boardName) {
                showResponseModal('failure', 'Board name is required');
                return;
            }

            let requestData = {
                board_name: boardName,
                schedule_type: scheduleType
            };

            if (scheduleType === 'absolute') {
                const startDatetime = document.getElementById('itemStartDatetime').value;
                const endDatetime = document.getElementById('itemEndDatetime').value;

                if (!startDatetime || !endDatetime) {
                    showResponseModal('failure', 'Start and end date/time are required');
                    return;
                }

                requestData.start_datetime = startDatetime;
                requestData.end_datetime = endDatetime;
            } else {
                // Relative pattern
                const patternType = document.getElementById('patternType').value;
                const startTime = document.getElementById('startTime').value;
                const endTime = document.getElementById('endTime').value;

                if (!startTime || !endTime) {
                    showResponseModal('failure', 'Start and end time are required');
                    return;
                }

                requestData.pattern_type = patternType;
                requestData.start_time = startTime;
                requestData.end_time = endTime;

                if (patternType === 'weekly') {
                    requestData.weekly_day = document.getElementById('weeklyDay').value;
                } else if (patternType === 'monthly') {
                    requestData.monthly_day = document.getElementById('monthlyDay').value;
                }
            }

            try {
                const url = editingItem 
                    ? `/schedules/${currentScheduleId}/items/${currentItemId}`
                    : `/schedules/${currentScheduleId}/items`;
                
                const method = editingItem ? 'PUT' : 'POST';

                const response = await fetch(url, {
                    method: method,
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(requestData)
                });

                const result = await response.json();
                if (response.ok) {
                    showResponseModal('success', result.message);
                    closeItemModal();
                    setTimeout(() => location.reload(), 1000);
                } else {
                    showResponseModal('failure', result.error);
                }
            } catch (error) {
                console.error('Error:', error);
                showResponseModal('failure', 'An error occurred while saving the schedule item');
            }
        }

        async function deleteScheduleItem(scheduleId, itemId) {
            if (!confirm('Are you sure you want to delete this schedule item?')) {
                return;
            }

            try {
                const response = await fetch(`/schedules/${scheduleId}/items/${itemId}`, {
                    method: 'DELETE'
                });

                const result = await response.json();
                if (response.ok) {
                    showResponseModal('success', result.message);
                    setTimeout(() => location.reload(), 1000);
                } else {
                    showResponseModal('failure', result.error);
                }
            } catch (error) {
                console.error('Error:', error);
                showResponseModal('failure', 'An error occurred while deleting the schedule item');
            }
        }

        function openCreateScheduleModal() {
            document.getElementById('scheduleModalTitle').textContent = 'Create New Schedule';
            document.getElementById('scheduleName').value = '';
            document.getElementById('scheduleActive').checked = true;
            document.getElementById('saveScheduleBtn').onclick = createSchedule;
            document.getElementById('scheduleModal').style.display = 'block';
        }

        function openEditScheduleModal(scheduleId, name, active) {
            document.getElementById('scheduleModalTitle').textContent = 'Edit Schedule';
            document.getElementById('scheduleName').value = name;
            document.getElementById('scheduleActive').checked = active;
            document.getElementById('saveScheduleBtn').onclick = function() {
                updateSchedule(scheduleId, document.getElementById('scheduleName').value.trim(), document.getElementById('scheduleActive').checked);
            };
            document.getElementById('scheduleModal').style.display = 'block';
        }

        function openCreateItemModal(scheduleId) {
            currentScheduleId = scheduleId;
            editingItem = false;
            document.getElementById('itemModalTitle').textContent = 'Create Schedule Item';
            
            // Reset form fields
            document.getElementById('itemStartDatetime').value = '';
            document.getElementById('itemEndDatetime').value = '';
            document.getElementById('itemBoardName').value = '';
            document.getElementById('startTime').value = '';
            document.getElementById('endTime').value = '';
            document.getElementById('patternType').value = 'daily';
            document.getElementById('weeklyDay').value = '1';
            document.getElementById('monthlyDay').value = '1';
            
            // Reset to absolute mode
            document.querySelector('input[name="scheduleType"][value="absolute"]').checked = true;
            toggleDateTimeInputs();
            
            document.getElementById('itemModal').style.display = 'block';
        }

        function openEditItemModal(scheduleId, itemId, itemData) {
            currentScheduleId = scheduleId;
            currentItemId = itemId;
            editingItem = true;
            document.getElementById('itemModalTitle').textContent = 'Edit Schedule Item';
            document.getElementById('itemBoardName').value = itemData.board_name;
            
            if (itemData.schedule_type === 'absolute') {
                // Set absolute mode
                document.querySelector('input[name="scheduleType"][value="absolute"]').checked = true;
                document.getElementById('itemStartDatetime').value = itemData.start_datetime.slice(0, 16);
                document.getElementById('itemEndDatetime').value = itemData.end_datetime.slice(0, 16);
            } else {
                // Set relative mode
                document.querySelector('input[name="scheduleType"][value="relative"]').checked = true;
                document.getElementById('patternType').value = itemData.pattern_type;
                document.getElementById('startTime').value = itemData.start_time;
                document.getElementById('endTime').value = itemData.end_time;
                
                if (itemData.pattern_type === 'weekly') {
                    document.getElementById('weeklyDay').value = itemData.weekly_day;
                } else if (itemData.pattern_type === 'monthly') {
                    document.getElementById('monthlyDay').value = itemData.monthly_day;
                }
            }
            
            toggleDateTimeInputs();
            document.getElementById('itemModal').style.display = 'block';
        }

        function closeScheduleModal() {
            document.getElementById('scheduleModal').style.display = 'none';
        }

        function closeItemModal() {
            document.getElementById('itemModal').style.display = 'none';
        }

        function toggleScheduleItems(scheduleId) {
            const itemsContainer = document.getElementById(`items-${scheduleId}`);
            const toggleButton = document.getElementById(`toggle-${scheduleId}`);
            
            if (itemsContainer.style.display === 'none' || itemsContainer.style.display === '') {
                itemsContainer.style.display = 'block';
                toggleButton.textContent = '▼';
            } else {
                itemsContainer.style.display = 'none';
                toggleButton.textContent = '▶';
            }
        }

        function toggleDateTimeInputs() {
            const scheduleType = document.querySelector('input[name="scheduleType"]:checked').value;
            const absoluteInputs = document.getElementById('absoluteInputs');
            const relativeInputs = document.getElementById('relativeInputs');
            
            if (scheduleType === 'absolute') {
                absoluteInputs.style.display = 'block';
                relativeInputs.style.display = 'none';
            } else {
                absoluteInputs.style.display = 'none';
                relativeInputs.style.display = 'block';
                updatePatternInputs();
            }
        }

        function updatePatternInputs() {
            const patternType = document.getElementById('patternType').value;
            const weeklyDayGroup = document.getElementById('weeklyDayGroup');
            const monthlyDayGroup = document.getElementById('monthlyDayGroup');
            
            // Hide all optional groups first
            weeklyDayGroup.style.display = 'none';
            monthlyDayGroup.style.display = 'none';
            
            // Show relevant group based on pattern type
            if (patternType === 'weekly') {
                weeklyDayGroup.style.display = 'block';
            } else if (patternType === 'monthly') {
                monthlyDayGroup.style.display = 'block';
            }
        }

        // Close modals when clicking outside
        window.onclick = function(event) {
            const scheduleModal = document.getElementById('scheduleModal');
            const itemModal = document.getElementById('itemModal');
            if (event.target === scheduleModal) {
                closeScheduleModal();
            }
            if (event.target === itemModal) {
                closeItemModal();
            }
        }
    </script>
</head>
<body>
    <div class="frame">
        <!-- Back Button -->
        <button onclick="history.back()" class="back-button">← Back</button>
        
        <!-- Header -->
        <div class="app-header">
            <div class="header-content">
                <div class="title-container">
                    <img src="{{ url_for('static', filename='icons/playlist.png') }}" alt="schedules icon" class="app-icon">
                    <h1 class="app-title">Schedules</h1>
                </div>
                <button class="header-button" onclick="openCreateScheduleModal()">New Schedule</button>
            </div>
        </div>
        <div class="separator"></div>
        
        <!-- Data Warning Banner -->
        {% if not data_init_success %}
        <div class="warning-banner">
            <div class="warning-content">
                <img src="{{ url_for('static', filename='icons/settings.png') }}" alt="warning" class="warning-icon">
                <div class="warning-text">
                    <strong>Data Warning:</strong> {{ data_init_message }}
                </div>
            </div>
        </div>
        {% endif %}
        
        <!-- Schedules List -->
        <div class="schedule-list">
            {% for schedule in schedules %}
            <div class="schedule-item">
                <div class="schedule-header">
                    <div class="schedule-info">
                        <button class="schedule-toggle" id="toggle-{{ schedule.id }}" onclick="toggleScheduleItems('{{ schedule.id }}')">▶</button>
                        <span class="schedule-name">{{ schedule.name }}</span>
                        {% if schedule.active %}
                        <span class="status-badge active">Active</span>
                        {% else %}
                        <span class="status-badge inactive">Inactive</span>
                        {% endif %}
                    </div>
                    <div class="schedule-actions">
                        <button class="action-btn add" onclick="openCreateItemModal('{{ schedule.id }}')" title="Add Schedule Item">
                            <img src="{{ url_for('static', filename='icons/edit.png') }}" alt="add" class="action-icon">
                        </button>
                        <button class="action-btn edit" onclick="openEditScheduleModal('{{ schedule.id }}', '{{ schedule.name }}', {{ schedule.active | lower }})" title="Edit Schedule">
                            <img src="{{ url_for('static', filename='icons/settings.png') }}" alt="edit" class="action-icon">
                        </button>
                        <button class="action-btn delete" onclick="deleteSchedule('{{ schedule.id }}')" title="Delete Schedule">
                            <img src="{{ url_for('static', filename='icons/remove.png') }}" alt="delete" class="action-icon">
                        </button>
                    </div>
                </div>
                
                <!-- Schedule Items -->
                <div id="items-{{ schedule.id }}" class="schedule-items" style="display: none;">
                    {% set schedule_items_filtered = schedule_items | selectattr('schedule_id', 'equalto', schedule.id) | list %}
                    {% if schedule_items_filtered %}
                        {% for item in schedule_items_filtered %}
                        <div class="schedule-item-row">
                            <div class="item-info">
                                <span class="item-board">{{ item.board_name }}</span>
                                {% if item.schedule_type == 'absolute' %}
                                <span class="item-datetime">{{ item.start_datetime }} - {{ item.end_datetime }}</span>
                                {% else %}
                                <span class="item-datetime">
                                    {% if item.pattern_type == 'daily' %}
                                        Daily {{ item.start_time }} - {{ item.end_time }}
                                    {% elif item.pattern_type == 'weekly' %}
                                        Weekly on {{ ['Sunday', 'Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday'][item.weekly_day] }} {{ item.start_time }} - {{ item.end_time }}
                                    {% elif item.pattern_type == 'monthly' %}
                                        Monthly on {{ item.monthly_day }}{{ 'st' if item.monthly_day|string|last == '1' and item.monthly_day != 11 else 'nd' if item.monthly_day|string|last == '2' and item.monthly_day != 12 else 'rd' if item.monthly_day|string|last == '3' and item.monthly_day != 13 else 'th' }} {{ item.start_time }} - {{ item.end_time }}
                                    {% endif %}
                                </span>
                                {% endif %}
                            </div>
                            <div class="item-actions">
                                <button class="action-btn edit" onclick="openEditItemModal('{{ schedule.id }}', '{{ item.id }}', {{ item | tojson | safe }})" title="Edit Item">
                                    <img src="{{ url_for('static', filename='icons/edit.png') }}" alt="edit" class="action-icon">
                                </button>
                                <button class="action-btn delete" onclick="deleteScheduleItem('{{ schedule.id }}', '{{ item.id }}')" title="Delete Item">
                                    <img src="{{ url_for('static', filename='icons/remove.png') }}" alt="delete" class="action-icon">
                                </button>
                            </div>
                        </div>
                        {% endfor %}
                    {% else %}
                        <div class="no-items">No schedule items yet. Click the + button to add one.</div>
                    {% endif %}
                </div>
            </div>
            {% endfor %}
            
            {% if not schedules %}
            <div class="no-schedules">
                <p>No schedules created yet.</p>
                <button class="action-button" onclick="openCreateScheduleModal()">Create Your First Schedule</button>
            </div>
            {% endif %}
        </div>
    </div>

    <!-- Schedule Modal -->
    <div id="scheduleModal" class="modal">
        <div class="modal-content">
            <span class="close-button" onclick="closeScheduleModal()">×</span>
            <h2 id="scheduleModalTitle">Create New Schedule</h2>
            <div class="separator"></div>
            <div class="form-group">
                <label for="scheduleName" class="form-label">Schedule Name:</label>
                <input type="text" id="scheduleName" name="scheduleName" placeholder="Enter schedule name..." required class="form-input">
            </div>
            <div class="form-group">
                <label class="form-label">
                    <input type="checkbox" id="scheduleActive" checked>
                    Active
                </label>
            </div>
            <div class="buttons-container">
                <button type="button" class="action-button" id="saveScheduleBtn">Save</button>
            </div>
        </div>
    </div>

    <!-- Schedule Item Modal -->
    <div id="itemModal" class="modal">
        <div class="modal-content">
            <span class="close-button" onclick="closeItemModal()">×</span>
            <h2 id="itemModalTitle">Create Schedule Item</h2>
            <div class="separator"></div>
            
            <!-- Date/Time Type Selection -->
            <div class="form-group">
                <label class="form-label">Schedule Type:</label>
                <div class="radio-group">
                    <label class="radio-label">
                        <input type="radio" name="scheduleType" value="absolute" checked onchange="toggleDateTimeInputs()">
                        Specific Date & Time
                    </label>
                    <label class="radio-label">
                        <input type="radio" name="scheduleType" value="relative" onchange="toggleDateTimeInputs()">
                        Recurring Pattern
                    </label>
                </div>
            </div>
            
            <!-- Absolute Date/Time Inputs -->
            <div id="absoluteInputs" class="date-inputs-group">
                <div class="form-group">
                    <label for="itemStartDatetime" class="form-label">Start Date & Time:</label>
                    <input type="datetime-local" id="itemStartDatetime" name="itemStartDatetime" class="form-input">
                </div>
                <div class="form-group">
                    <label for="itemEndDatetime" class="form-label">End Date & Time:</label>
                    <input type="datetime-local" id="itemEndDatetime" name="itemEndDatetime" class="form-input">
                </div>
            </div>
            
            <!-- Relative Pattern Inputs -->
            <div id="relativeInputs" class="date-inputs-group" style="display: none;">
                <div class="form-group">
                    <label for="patternType" class="form-label">Pattern:</label>
                    <select id="patternType" name="patternType" class="form-input" onchange="updatePatternInputs()">
                        <option value="daily">Daily</option>
                        <option value="weekly">Weekly</option>
                        <option value="monthly">Monthly</option>
                    </select>
                </div>
                
                <div class="form-group" id="weeklyDayGroup" style="display: none;">
                    <label for="weeklyDay" class="form-label">Day of Week:</label>
                    <select id="weeklyDay" name="weeklyDay" class="form-input">
                        <option value="0">Sunday</option>
                        <option value="1">Monday</option>
                        <option value="2">Tuesday</option>
                        <option value="3">Wednesday</option>
                        <option value="4">Thursday</option>
                        <option value="5">Friday</option>
                        <option value="6">Saturday</option>
                    </select>
                </div>
                
                <div class="form-group" id="monthlyDayGroup" style="display: none;">
                    <label for="monthlyDay" class="form-label">Day of Month:</label>
                    <input type="number" id="monthlyDay" name="monthlyDay" min="1" max="31" value="1" class="form-input">
                </div>
                
                <div class="form-group">
                    <label for="startTime" class="form-label">Start Time:</label>
                    <input type="time" id="startTime" name="startTime" class="form-input">
                </div>
                
                <div class="form-group">
                    <label for="endTime" class="form-label">End Time:</label>
                    <input type="time" id="endTime" name="endTime" class="form-input">
                </div>
            </div>
            
            <div class="form-group">
                <label for="itemBoardName" class="form-label">Board Name:</label>
                <input type="text" id="itemBoardName" name="itemBoardName" placeholder="Enter board name..." required class="form-input">
            </div>
            <div class="buttons-container">
                <button type="button" class="action-button" onclick="createScheduleItem()">Save</button>
            </div>
        </div>
    </div>

    <!-- Success/Error Modal -->
    {% include 'response_modal.html' %}
</body>
</html> 